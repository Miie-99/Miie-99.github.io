<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒäººå¥³è·³å‘æ¨¡æ‹Ÿå™¨ (çˆ¬å¢™Edition)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f3f4f6;
            overflow-x: hidden;
        }

        /* èµ›é©¬å¨˜é£æ ¼UIé…è‰² */
        .uma-header {
            background: linear-gradient(135deg, #6ee7b7 0%, #3b82f6 100%);
        }
        
        .uma-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .stat-bar-bg {
            background-color: #e5e7eb;
            border-radius: 9999px;
            height: 10px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }

        /* è€è™æœºåŠ¨ç”» */
        .slot-machine-window {
            height: 60px;
            overflow: hidden;
            background: #f0f9ff;
            border: 3px solid #3b82f6;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e40af;
        }

        .scrolling {
            animation: scrollText 0.1s infinite linear;
        }

        .dialog-box {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            min-height: 100px;
        }

        .event-modal {
            background: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* èœ˜è››ç½‘å›¾ SVG */
        .radar-chart {
            width: 100%;
            height: auto;
            max-width: 300px;
            margin: 0 auto;
        }
        
        .text-outline {
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
        }
        
        .platform-tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            display: inline-block;
        }
        .platform-wb { background: #fca5a5; color: #7f1d1d; }
        .platform-lof { background: #86efac; color: #14532d; }
        .platform-ao3 { background: #ef4444; color: white; }
        .platform-x { background: #3b82f6; color: white; }
        .platform-gp { background: #fcd34d; color: #78350f; } /* ç‹—å±/å°ç¾¤ */

    </style>
</head>
<body class="text-gray-800 h-screen flex flex-col">

    <!-- 1. å¼€å§‹é¡µé¢ / è®¾å®šé¡µé¢ -->
    <div id="setup-screen" class="flex-1 flex flex-col items-center justify-center p-4 max-w-md mx-auto w-full">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600">åŒäººå¥³è·³å‘æ¨¡æ‹Ÿå™¨<br><span class="text-sm text-gray-500">çˆ¬å¢™ Edition</span></h1>
        
        <div class="w-full space-y-4 bg-white p-6 rounded-xl shadow-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">æˆ‘çš„CP (æœ¬å‘½)</label>
                <input type="text" id="cp-name" value="AB" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ä¾‹å¦‚: ä¼å…«">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">å¯¹å®¶/é€†å®¶ (æ­»æ•Œ)</label>
                <input type="text" id="rival-name" value="BA" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="ä¾‹å¦‚: å…«ä¼">
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æŠ½å–è½¬ç”Ÿèº«ä»½</label>
                <div class="flex gap-2 mb-2">
                    <div id="slot-prefix" class="slot-machine-window w-1/2">???</div>
                    <div id="slot-role" class="slot-machine-window w-1/2">???</div>
                </div>
                <button onclick="spinIdentity()" id="spin-btn" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-4 rounded transition">
                    ğŸ² å¼€å§‹æ‘‡å·
                </button>
            </div>

            <div id="identity-result" class="hidden p-3 bg-blue-50 rounded text-sm text-blue-800">
                <p><strong>èº«ä»½æ•ˆæœï¼š</strong><span id="identity-buff"></span></p>
            </div>

            <button onclick="startGame()" id="start-game-btn" disabled class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition opacity-50 cursor-not-allowed mt-6">
                è·³å‘ï¼å¼€å§‹äº§ç²®
            </button>
        </div>
    </div>

    <!-- 2. æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-screen" class="hidden flex-col h-full max-w-md mx-auto w-full bg-gray-50 relative">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  (å››å¤§ç»´) -->
        <div class="uma-header p-4 text-white rounded-b-xl shadow-md z-10">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <div class="text-xs opacity-90">ç¬¬ <span id="year-disp">1</span> å¹´ <span id="month-disp">1</span> æœˆ <span id="week-disp">ä¸Šæ—¬</span></div>
                    <div class="font-bold text-lg" id="turn-phase">é˜¶æ®µ: åˆšå…¥å‘</div>
                </div>
                <div class="text-right">
                    <div class="text-xs">ç²¾ç¥çŠ¶æ€(San)</div>
                    <div class="font-bold text-xl flex items-center gap-1 justify-end">
                         <span id="val-san">100</span> <i data-lucide="brain" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <!-- æ ¸å¿ƒå››ç»´ -->
            <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>CPçƒ­åº¦</span> <span id="val-cpheat">0</span></div>
                    <div class="stat-bar-bg"><div id="bar-cpheat" class="stat-bar-fill bg-red-400" style="width: 10%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>æˆ‘çš„çƒ­åº¦</span> <span id="val-myheat">0</span></div>
                    <div class="stat-bar-bg"><div id="bar-myheat" class="stat-bar-fill bg-purple-400" style="width: 0%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>å¨åŠ›/çˆ±</span> <span id="val-love">50</span></div>
                    <div class="stat-bar-bg"><div id="bar-love" class="stat-bar-fill bg-pink-500" style="width: 50%"></div></div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1"><span>æŠ€æœ¯/äº§å‡ºåŠ›</span> <span id="val-tech">10</span></div>
                    <div class="stat-bar-bg"><div id="bar-tech" class="stat-bar-fill bg-blue-400" style="width: 10%"></div></div>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šç«‹ç»˜/äº‹ä»¶åé¦ˆåŒº -->
        <div class="flex-1 overflow-y-auto p-4 flex flex-col relative">
            <!-- èµ„æºæ  (ä¾§è¾¹æˆ–æ‚¬æµ®) -->
            <div class="bg-white p-2 rounded-lg shadow flex justify-around text-xs font-bold text-gray-600 mb-4">
                <div class="flex items-center gap-1"><i data-lucide="zap" class="w-3 h-3 text-yellow-500"></i> çƒ­æƒ…: <span id="val-passion">100</span></div>
                <div class="flex items-center gap-1"><i data-lucide="battery" class="w-3 h-3 text-green-500"></i> ä½“åŠ›: <span id="val-stamina">100</span></div>
                <div class="flex items-center gap-1"><i data-lucide="coins" class="w-3 h-3 text-yellow-600"></i> å­˜æ¬¾: <span id="val-money">1000</span></div>
                <div class="flex items-center gap-1"><i data-lucide="users" class="w-3 h-3 text-blue-500"></i> ç°å……: <span id="val-social">50</span></div>
            </div>

            <!-- ä¸»è¦æ–‡æœ¬æ˜¾ç¤º -->
            <div class="dialog-box shadow-inner flex-1 flex flex-col justify-end mb-4 relative">
                 <div class="absolute top-2 right-2 opacity-10 text-6xl">ğŸ’¬</div>
                 <div id="game-log" class="space-y-2 text-sm overflow-y-auto max-h-60">
                    <p class="text-gray-500 italic">åªè¦ç‚¹å‡»ä¸‹æ–¹è¡ŒåŠ¨ï¼Œæ—¶é—´å°±ä¼šæµåŠ¨...</p>
                 </div>
            </div>

            <!-- ç›®æ ‡æç¤º -->
            <div class="bg-yellow-50 border border-yellow-200 rounded p-2 text-xs text-yellow-800 mb-2">
                ğŸ¯ å½“å‰ç›®æ ‡: <span id="current-goal">åŠå¹´å†…å‡ºæœ¬å°æ–™åˆé›† (è¿›åº¦: <span id="work-count">0</span>/3 ç¯‡)</span>
            </div>
        </div>

        <!-- åº•éƒ¨è¡ŒåŠ¨å¡ç‰‡ -->
        <div class="p-4 bg-white border-t border-gray-200 pb-8">
            <div class="grid grid-cols-3 gap-2">
                <button onclick="doAction('work')" class="p-2 rounded bg-gray-100 hover:bg-gray-200 border border-gray-300 flex flex-col items-center">
                    <i data-lucide="briefcase" class="mb-1 text-gray-600"></i>
                    <span class="text-xs font-bold">ç°å……/æ‰“å·¥</span>
                    <span class="text-[10px] text-gray-400">é‡‘é’±â†‘ ç¤¾äº¤â†‘</span>
                </button>
                <button onclick="doAction('create')" class="p-2 rounded bg-blue-50 hover:bg-blue-100 border border-blue-200 flex flex-col items-center">
                    <i data-lucide="pen-tool" class="mb-1 text-blue-600"></i>
                    <span class="text-xs font-bold">äº§ç²®/çº¦ç¨¿</span>
                    <span class="text-[10px] text-gray-400">çƒ­åº¦â†‘ æŠ€æœ¯â†‘</span>
                </button>
                <button onclick="doAction('consume')" class="p-2 rounded bg-pink-50 hover:bg-pink-100 border border-pink-200 flex flex-col items-center">
                    <i data-lucide="eye" class="mb-1 text-pink-600"></i>
                    <span class="text-xs font-bold">å—‘ç³–/çˆ¬æ¥¼</span>
                    <span class="text-[10px] text-gray-400">å¨åŠ›â†‘ Sanâ†“</span>
                </button>
                <button onclick="doAction('social')" class="p-2 rounded bg-purple-50 hover:bg-purple-100 border border-purple-200 flex flex-col items-center">
                    <i data-lucide="message-circle" class="mb-1 text-purple-600"></i>
                    <span class="text-xs font-bold">æ··åœˆ/æ‰©åˆ—</span>
                    <span class="text-[10px] text-gray-400">çƒ­åº¦â†‘ é£é™©â†‘</span>
                </button>
                <button onclick="doAction('rest')" class="p-2 rounded bg-green-50 hover:bg-green-100 border border-green-200 flex flex-col items-center">
                    <i data-lucide="coffee" class="mb-1 text-green-600"></i>
                    <span class="text-xs font-bold">ç¡è§‰/é€€ç½‘</span>
                    <span class="text-[10px] text-gray-400">ä½“åŠ›â†‘ Sanâ†‘</span>
                </button>
                <button onclick="showStatus()" class="p-2 rounded bg-yellow-50 hover:bg-yellow-100 border border-yellow-200 flex flex-col items-center">
                    <i data-lucide="clipboard-list" class="mb-1 text-yellow-600"></i>
                    <span class="text-xs font-bold">æŸ¥çœ‹çŠ¶æ€</span>
                    <span class="text-[10px] text-gray-400">è¯¦ç»†æ•°æ®</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. ç»“å±€/ç»“ç®—é¡µé¢ -->
    <div id="end-screen" class="hidden flex-col items-center justify-center p-4 min-h-screen bg-gray-900 text-white overflow-y-auto">
        <div class="max-w-md w-full bg-gray-800 p-6 rounded-xl shadow-2xl border border-gray-700 my-8">
            <h2 class="text-3xl font-bold text-center mb-2 text-yellow-400">é€€å‘/å®Œç»“çºªå¿µ</h2>
            <p class="text-center text-gray-400 text-sm mb-6" id="end-reason">ç”±äºçƒ­æƒ…è€—å°½ï¼Œä½ åœ¨è¿™ä¸ªå‘çš„æ—…ç¨‹ç»“æŸäº†ã€‚</p>
            
            <!-- èœ˜è››ç½‘å›¾å®¹å™¨ -->
            <div class="relative w-64 h-64 mx-auto mb-6 bg-gray-700 rounded-full flex items-center justify-center">
                <svg id="radar-svg" viewBox="0 0 200 200" class="w-full h-full overflow-visible">
                    <!-- è¿™é‡Œçš„å›¾å½¢ä¼šé€šè¿‡JSç”Ÿæˆ -->
                </svg>
            </div>

            <div class="text-center mb-6">
                <div class="text-gray-400 text-xs uppercase tracking-wide">æœ€ç»ˆè¯„ä»·</div>
                <div class="text-2xl font-bold text-white mt-1" id="final-title">ç»ä¸–å¤§è§¦</div>
                <div class="text-sm text-gray-300 mt-2 px-4 italic" id="final-desc">"è™½ç„¶é€€å‘äº†ï¼Œä½†æ±Ÿæ¹–ä¸Šè¿˜æµä¼ ç€ä½ çš„ä¼ è¯´..."</div>
            </div>

            <div class="space-y-2 bg-gray-900 p-4 rounded border border-gray-700 text-sm mb-6">
                <div class="flex justify-between"><span>äº§å‡ºä½œå“:</span> <span id="end-works" class="text-blue-400">0</span></div>
                <div class="flex justify-between"><span>ç²‰ä¸æ•°é‡:</span> <span id="end-fans" class="text-pink-400">0</span></div>
                <div class="flex justify-between"><span>å­˜æ¬¾å‰©ä½™:</span> <span id="end-money" class="text-green-400">0</span></div>
                <div class="flex justify-between"><span>ç²¾ç¥çŠ¶æ€:</span> <span id="end-san" class="text-red-400">0</span></div>
            </div>

            <button onclick="location.reload()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition">
                çˆ¬ä¸‹ä¸€ä¸ªå‘ (é‡æ¥)
            </button>
        </div>
    </div>

    <!-- äº‹ä»¶å¼¹çª— -->
    <div id="event-modal" class="hidden event-modal">
        <div class="bg-white p-6 rounded-lg max-w-sm w-[90%] shadow-2xl transform transition-all scale-100">
            <h3 id="event-title" class="text-lg font-bold mb-2 text-purple-700">äº‹ä»¶å‘ç”Ÿ!</h3>
            <div id="event-content" class="text-gray-700 mb-4 text-sm leading-relaxed">
                å†…å®¹...
            </div>
            <button onclick="closeEvent()" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700">ç¡®å®š</button>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆæ•°æ®é…ç½® ---
        
        const PREFIXES = [
            { text: "ä¸‹æ¥¼æ¢¯éª¨æŠ˜çš„", buff: "social-", desc: "ç°å……åº¦é™ä½ï¼Œä½†ä¼šæœ‰åŒæƒ…åˆ†" },
            { text: "å¤©èµ‹å¼‚ç¦€çš„", buff: "tech+", desc: "æ¯æ¬¡äº§ç²®æŠ€æœ¯é¢å¤–+5" },
            { text: "å®¶é‡Œæœ‰çŸ¿çš„", buff: "money+", desc: "åˆå§‹é‡‘é’±+5000" },
            { text: "ç»ç’ƒå¿ƒçš„", buff: "san-", desc: "Sanå€¼æ¶ˆè€—ç¿»å€ï¼Œä½†å®¹æ˜“äº§å‡ºemoæ–‡å­¦" },
            { text: "ä½åœ¨Aç«™çš„", buff: "passion+", desc: "çƒ­æƒ…ä¸Šé™æ›´é«˜" },
            { text: "ç»èµæ‹–å»¶ç—‡çš„", buff: "stamina-", desc: "ä½“åŠ›æ¶ˆè€—å¢åŠ " },
            { text: "å˜´å·´å¾ˆç¡¬çš„", buff: "rival+", desc: "æ›´å®¹æ˜“å’Œå¯¹å®¶åµæ¶" },
            { text: "ç°å……å¤§å¿™äºº", buff: "time-", desc: "æ¯å‘¨è¡ŒåŠ¨åé¢å¤–æ‰£ä½“åŠ›" }
        ];

        const ROLES = [
            { text: "ç¤¾ç•œ", type: "draw", stat: { money: 2000, time: 2 } },
            { text: "å­¦ç”Ÿ", type: "write", stat: { money: 500, time: 4 } },
            { text: "è‡ªç”±èŒä¸š", type: "mix", stat: { money: 1000, time: 5 } },
            { text: "æ— ä¸šæ¸¸æ°‘", type: "consumer", stat: { money: 100, time: 6 } }
        ];

        // æ¸¸æˆçŠ¶æ€
        let state = {
            turn: 1, // 1-48 (4å‘¨ * 12æœˆ)
            cpName: "",
            rivalName: "",
            identity: { prefix: null, role: null },
            stats: {
                cpHeat: 10,    // CPåœˆå­çƒ­åº¦
                myHeat: 0,     // ä¸ªäººçƒ­åº¦
                love: 50,      // å¨åŠ›
                san: 80,       // Sanå€¼ (ç²¾ç¥)
                passion: 100,  // çƒ­æƒ… (å½’é›¶é€€å‘)
                stamina: 100,  // ä½“åŠ›
                money: 1000,   // å­˜æ¬¾
                social: 30,    // ç°å……/ç¤¾äº¤
                tech: 10       // æŠ€æœ¯/æ–‡ç¬”ç”»åŠ›
            },
            works: 0, // ä½œå“æ•°
            flags: {
                halfYearGoalMet: false,
                toxic: false, // æ˜¯å¦å˜æˆç–¯ç‹—
                goddess: false // æ˜¯å¦å˜æˆå¥³ç¥
            },
            history: []
        };

        // --- é€»è¾‘å‡½æ•° ---

        // 1. åˆå§‹åŒ–ä¸æ‘‡å·
        function spinIdentity() {
            const pEl = document.getElementById('slot-prefix');
            const rEl = document.getElementById('slot-role');
            const btn = document.getElementById('spin-btn');
            const startBtn = document.getElementById('start-game-btn');
            
            btn.disabled = true;
            pEl.classList.add('scrolling');
            rEl.classList.add('scrolling');

            // æ¨¡æ‹Ÿæ»šåŠ¨åŠ¨ç”»
            let interval = setInterval(() => {
                pEl.innerText = PREFIXES[Math.floor(Math.random() * PREFIXES.length)].text;
                rEl.innerText = ROLES[Math.floor(Math.random() * ROLES.length)].text;
            }, 50);

            setTimeout(() => {
                clearInterval(interval);
                pEl.classList.remove('scrolling');
                rEl.classList.remove('scrolling');
                
                // é”å®šç»“æœ
                const finalPrefix = PREFIXES[Math.floor(Math.random() * PREFIXES.length)];
                const finalRole = ROLES[Math.floor(Math.random() * ROLES.length)];
                
                state.identity.prefix = finalPrefix;
                state.identity.role = finalRole;
                
                // åº”ç”¨åˆå§‹Buff
                document.getElementById('identity-buff').innerText = `${finalPrefix.desc} + èŒä¸šç‰¹æ€§`;
                document.getElementById('identity-result').classList.remove('hidden');
                
                // åº”ç”¨æ•°å€¼
                if (finalPrefix.buff === "money+") state.stats.money += 5000;
                if (finalPrefix.buff === "passion+") state.stats.passion = 150;
                state.stats.money += finalRole.stat.money;

                btn.innerText = "é‡æ‘‡ (å¹¶ä¸)";
                btn.disabled = true; // åªèƒ½æ‘‡ä¸€æ¬¡ (ç¡¬æ ¸)
                startBtn.disabled = false;
                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }, 1500);
        }

        function startGame() {
            state.cpName = document.getElementById('cp-name').value || "AB";
            state.rivalName = document.getElementById('rival-name').value || "BA";
            
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('game-screen').classList.add('flex');
            
            updateUI();
            addLog(`ä½ (${state.identity.prefix.text}${state.identity.role.text}) å‚ç›´å…¥å‘äº† ${state.cpName}ï¼`, "system");
            lucide.createIcons();
        }

        // 2. å›åˆè¡ŒåŠ¨ç³»ç»Ÿ
        function doAction(type) {
            // æ£€æŸ¥ä½“åŠ›
            if (state.stats.stamina <= 10 && type !== 'rest') {
                alert("ä½“åŠ›ä¸è¶³ï¼Œå¿…é¡»ä¼‘æ¯ï¼");
                return;
            }

            let msg = "";
            let eventTrigger = false;

            // åŸºç¡€æ¶ˆè€—
            state.stats.stamina -= 15;
            state.stats.passion -= 2; // æ¯å›åˆè‡ªç„¶æ¶ˆé€€
            state.turn++;

            switch(type) {
                case 'work':
                    state.stats.money += 500;
                    state.stats.social += 5;
                    state.stats.passion -= 5; // å·¥ä½œæ¶ˆç£¨çƒ­æƒ…
                    msg = "åšäº†ä¸€å‘¨çš„ç¤¾ç•œ/ç°å……ï¼Œèµšäº†ç‚¹é’±ï¼Œä½†æ„Ÿè§‰ç¦»äºŒæ¬¡å…ƒè¿œäº†ã€‚";
                    break;
                case 'create':
                    const skillGain = state.identity.prefix.buff === "tech+" ? 10 : 5;
                    state.stats.tech += skillGain;
                    state.stats.myHeat += 2;
                    state.stats.stamina -= 10; // é¢å¤–ä½“åŠ›
                    state.works += 0.5; // è¿›åº¦
                    msg = "çˆ†è‚äº§ç²®ï¼è™½ç„¶å¾ˆç´¯ï¼Œä½†çœ‹åˆ°ç‚¹èµæ•°å¢åŠ äº†ã€‚";
                    if (Math.random() > 0.7) eventTrigger = true;
                    break;
                case 'consume':
                    state.stats.love += 5;
                    state.stats.san -= 5; // çœ‹å¤šäº†å®¹æ˜“çœ‹åˆ°é»‘æ³¥
                    state.stats.passion += 5;
                    msg = "åˆ·äº†ä¸€æ•´å¤©tagï¼Œåƒåˆ°äº†ç²®ä¹Ÿåƒåˆ°äº†å±ã€‚";
                    if (Math.random() > 0.6) eventTrigger = true;
                    break;
                case 'social':
                    state.stats.myHeat += 5;
                    state.stats.san -= 8; // ç¤¾äº¤æ¶ˆè€—ç²¾ç¥
                    state.stats.social -= 5; // æ··åœˆå…¶å®æ˜¯å‡å°‘ç°å……åº¦çš„
                    msg = "åœ¨å°ç¾¤é‡Œæ°´äº†ä¸€å¤©ï¼Œå¬äº†å¾ˆå¤šå…«å¦ã€‚";
                    eventTrigger = true;
                    break;
                case 'rest':
                    state.stats.stamina += 50;
                    state.stats.san += 10;
                    if(state.stats.stamina > 100) state.stats.stamina = 100;
                    state.stats.passion -= 5; // ä¼‘æ¯ä¸äº§ç²®ä¼šå†·æ·¡
                    msg = "ç¡äº†ä¸€å¤§è§‰ï¼Œæ–­ç½‘ä¿å¹³å®‰ã€‚";
                    break;
            }

            addLog(msg);
            updateUI();

            // æ£€æŸ¥äº‹ä»¶
            if (eventTrigger || Math.random() > 0.8) {
                setTimeout(triggerRandomEvent, 500);
            } else {
                checkGameStatus();
            }
        }

        // 3. äº‹ä»¶ç³»ç»Ÿ (åŸºäºåŒäººå¥³è¯­æ–™åº“)
        const EVENTS = [
            {
                title: "AO3 ç»ä¸–å¥½æ–‡",
                text: "åœ¨Aç«™è¯»åˆ°ä¸€ç¯‡ã€Š{cp}ã€‹çš„æ¸…æ°´æ–‡ï¼Œæ–‡ç¬”æƒŠä¸ºå¤©äººï¼Œè¿™æ˜¯ä»€ä¹ˆç¥ä»™å¤ªå¤ªï¼",
                effect: () => { state.stats.love += 20; state.stats.passion += 20; state.stats.san += 10; }
            },
            {
                title: "KY å‡ºæ²¡",
                text: "ä½ åœ¨å‘{cp}çš„ç³–ï¼Œè¯„è®ºåŒºçªç„¶æœ‰äººé—®ï¼š'åªæœ‰æˆ‘è§‰å¾—{rival}æ›´çœŸå—ï¼Ÿ'ï¼Œä½ æ„Ÿåˆ°ä¸€é˜µæ¶å¿ƒã€‚",
                effect: () => { state.stats.san -= 15; state.stats.passion -= 5; }
            },
            {
                title: "å®˜æ–¹èƒŒåˆº",
                text: "æœ€æ–°è¿è½½é‡Œï¼Œå®˜æ–¹å±…ç„¶ç»™äº†{rival}ä¸€ä¸ªå¯¹è§†ç‰¹å†™ï¼è¿™æ˜¯åœ¨å–è…å—ï¼Ÿå®˜æ–¹ä½ æœ‰å¿ƒå—ï¼Ÿ",
                effect: () => { state.stats.san -= 30; state.stats.cpHeat += 20; state.stats.love -= 10; }
            },
            {
                title: "å°å›¢ä½“ç‚¸äº†",
                text: "ä½ æ‰€åœ¨çš„é‚£ä¸ª'æ´ç™–åªæœ‰æˆ‘ä»¬'çš„å°ç¾¤èŠå¤©è®°å½•è¢«æ³„éœ²äº†ï¼Œé‡Œé¢åæ§½å¤§æ‰‹çš„è®°å½•è¢«æŒ‚åˆ°äº†å¾®åšå¹¿åœºã€‚",
                effect: () => { state.stats.myHeat += 50; state.stats.san -= 50; state.stats.social -= 20; state.flags.toxic = true; }
            },
            {
                title: "çº¦ç¨¿ç¿»è½¦",
                text: "èŠ±å¤§ä»·é’±çº¦çš„å›¾ï¼Œç”»æ‰‹å±…ç„¶æŠŠ{cp}çš„å·¦å³ä½ç”»åäº†ï¼ç”šè‡³è¿˜ä¸å¦‚ä½ è‡ªå·±ç”»çš„ç«æŸ´äººã€‚",
                effect: () => { state.stats.money -= 500; state.stats.san -= 20; }
            },
            {
                title: "è€ç¦ç‰¹é™æµ",
                text: "ä½ å†™çš„ä¸‡å­—é•¿è½¦è¢«è€ç¦ç‰¹å±å¼Šäº†ï¼Œç”³è¯‰äº†ä¸‰æ¬¡ä¹Ÿæ²¡è¿‡ã€‚å¿ƒå¥½ç´¯ã€‚",
                effect: () => { state.stats.passion -= 15; state.stats.myHeat -= 5; }
            },
            {
                title: "è“é¸Ÿå¥³ç¥äº’å…³",
                text: "ä½ åœ¨æ¨ç‰¹/Xä¸Šå‘çš„ç”»è¢«æ¨±èŠ±å¦¹å¥³ç¥è½¬æ¨äº†ï¼ç”±äºè¯­è¨€ä¸é€šï¼Œä½ ä»¬åªèƒ½äº’å‘emojiã€‚",
                effect: () => { state.stats.myHeat += 30; state.stats.tech += 5; state.stats.passion += 10; }
            },
            {
                title: "å†·åœˆæåœ°",
                text: "äº§äº†ä¸€å‘¨çš„ç²®ï¼Œåªæœ‰3ä¸ªèµï¼Œå…¶ä¸­ä¸€ä¸ªè¿˜æ˜¯ä½ è‡ªå·±ç‚¹çš„ã€‚è¿™å°±æ˜¯åŒ—æåœˆå—ï¼Ÿ",
                effect: () => { state.stats.passion -= 20; state.stats.san -= 5; }
            },
            {
                title: "è°·å­å‡ºæ–°",
                text: "å®˜æ–¹å‡ºäº†æ–°çš„å§å”§ï¼ˆå¾½ç« ï¼‰ï¼Œä½†æ˜¯æ˜¯ç›²è¢‹ï¼Œè€Œä¸”{cp}ä¸¤ä¸ªäººæ˜¯åˆ†Hiddenæ¬¾ã€‚",
                effect: () => { 
                    if(state.stats.money > 200) {
                        state.stats.money -= 200; 
                        state.stats.love += 10;
                        return "ä½ æ²¡å¿ä½All inäº†ä¸€ç›’ã€‚é’±åŒ…ç—›å¹¶åœ¨å¿«ä¹ç€ã€‚";
                    } else {
                        state.stats.san -= 10;
                        return "æ²¡é’±ä¹°ï¼Œçœ‹ç€åˆ«äººæ™’è°·ï¼Œæµä¸‹äº†è´«ç©·çš„æ³ªæ°´ã€‚";
                    }
                }
            }
        ];

        function triggerRandomEvent() {
            const evt = EVENTS[Math.floor(Math.random() * EVENTS.length)];
            let content = evt.text.replace(/{cp}/g, state.cpName).replace(/{rival}/g, state.rivalName);
            
            // æ‰§è¡Œæ•ˆæœ
            const resultText = evt.effect();
            if (resultText) content += `<br><br><span class='text-blue-600'>${resultText}</span>`;

            showEventModal(evt.title, content);
        }

        function showEventModal(title, content) {
            document.getElementById('event-title').innerText = title;
            document.getElementById('event-content').innerHTML = content;
            document.getElementById('event-modal').classList.remove('hidden');
        }

        function closeEvent() {
            document.getElementById('event-modal').classList.add('hidden');
            checkGameStatus();
        }

        // 4. çŠ¶æ€æ£€æŸ¥ä¸æ›´æ–°
        function checkGameStatus() {
            // æ£€æŸ¥åŠå¹´ç›®æ ‡
            if (state.turn === 24) {
                if (state.works >= 3) {
                    showEventModal("åŠå¹´ç»“ç®—", "ä½ çš„å°æ–™åˆé›†é¡ºåˆ©å‡ºäº§ï¼åœ¨åœˆå†…å°æœ‰åæ°”ã€‚");
                    state.stats.myHeat += 50;
                    state.stats.passion += 30;
                } else {
                    showEventModal("åŠå¹´ç»“ç®—", "åŠå¹´è¿‡å»äº†ï¼Œä½ çª—äº†ï¼ˆæ²¡äº§å‡ºï¼‰ã€‚çœ‹ç€åˆ«äººçš„æœ¬å­ï¼Œä½ æ„Ÿåˆ°ç¾æ„§ã€‚");
                    state.stats.san -= 20;
                    state.stats.myHeat -= 10;
                }
            }

            // æ£€æŸ¥é€€å‘æ¡ä»¶
            if (state.stats.passion <= 0) {
                endGame("æ·¡å‘é€€åœˆ");
            } else if (state.stats.san <= 0) {
                endGame("ç ´é˜²é€€ç½‘");
            } else if (state.stats.money < -500) {
                endGame("ç ´äº§å–å·");
            } else if (state.turn > 48) {
                endGame("ä¸€å‘¨å¹´çºªå¿µ");
            }
        }

        function updateUI() {
            // æ›´æ–°æ–‡æœ¬
            const month = Math.ceil(state.turn / 4);
            const week = state.turn % 4 || 4;
            const weekStr = ["", "ç¬¬ä¸€å‘¨", "ç¬¬äºŒå‘¨", "ç¬¬ä¸‰å‘¨", "ç¬¬å››å‘¨"][week];
            
            document.getElementById('year-disp').innerText = 1;
            document.getElementById('month-disp').innerText = month;
            document.getElementById('week-disp').innerText = weekStr;
            document.getElementById('work-count').innerText = Math.floor(state.works);

            // æ›´æ–°æ•°å€¼
            updateStat('san', state.stats.san, 100);
            updateStat('cpheat', state.stats.cpHeat, 100);
            updateStat('myheat', state.stats.myHeat, 200);
            updateStat('love', state.stats.love, 100);
            updateStat('tech', state.stats.tech, 100);
            
            document.getElementById('val-passion').innerText = state.stats.passion;
            document.getElementById('val-stamina').innerText = state.stats.stamina;
            document.getElementById('val-money').innerText = state.stats.money;
            document.getElementById('val-social').innerText = state.stats.social;

            // é˜¶æ®µæ–‡å­—
            let phaseText = "èŒæ–°å…¥å‘";
            if (state.stats.myHeat > 50) phaseText = "å°æœ‰åæ°”";
            if (state.stats.myHeat > 150) phaseText = "åœˆå†…å¤§æ‰‹";
            if (state.stats.san < 30) phaseText = "ç–¯ç‹—æ¨¡å¼";
            document.getElementById('turn-phase').innerText = "é˜¶æ®µ: " + phaseText;
        }

        function updateStat(id, val, max) {
            const el = document.getElementById(`val-${id}`);
            const bar = document.getElementById(`bar-${id}`);
            if (el) el.innerText = val;
            if (bar) {
                let pct = (val / max) * 100;
                if (pct > 100) pct = 100;
                if (pct < 0) pct = 0;
                bar.style.width = pct + '%';
            }
        }

        function addLog(msg, type="normal") {
            const log = document.getElementById('game-log');
            const p = document.createElement('p');
            p.className = type === "system" ? "text-blue-600 font-bold" : "text-gray-700";
            p.innerHTML = `Processing... ${msg}`; // å‡è£…loading
            setTimeout(() => {
                 p.innerHTML = `<span class="text-xs text-gray-400">[ç¬¬${state.turn}å‘¨]</span> ${msg}`;
            }, 100);
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }

        // 5. ç»“å±€ä¸ç»˜å›¾
        function endGame(reason) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            document.getElementById('end-screen').classList.add('flex');
            
            document.getElementById('end-reason').innerText = `ç»“å±€åŸå› : ${reason}`;
            document.getElementById('end-works').innerText = Math.floor(state.works);
            document.getElementById('end-fans').innerText = state.stats.myHeat * 100 + Math.floor(Math.random()*50);
            document.getElementById('end-money').innerText = state.stats.money;
            document.getElementById('end-san').innerText = state.stats.san;

            // ç§°å·è®¡ç®—
            let title = "é»˜é»˜æ— é—»çš„è·¯äºº";
            let desc = "ä½ åœ¨å‘è¾¹èµ°äº†èµ°ï¼Œæ²¡å¸¦èµ°ä¸€ç‰‡äº‘å½©ã€‚";

            if (state.stats.myHeat > 180 && state.stats.tech > 80) {
                title = "ç¥ä»™å¤ªå¤ª (é•‡åœˆä¹‹å®)";
                desc = "ä½ çš„æ¯ä¸€æ¡ç²®éƒ½è¢«ä¾›åœ¨è¶…è¯åŠ ç²¾ï¼Œé€€å‘é‚£å¤©å…¨ç½‘å“€åšã€‚";
            } else if (state.stats.money > 10000) {
                title = "å¯Œå©† / é’èƒ½åŠ›è€…";
                desc = "è™½ç„¶ä¸äº§ç²®ï¼Œä½†ä½ çº¦éäº†å…¨åœˆç”»æ‰‹ï¼Œæ˜¯æ‰€æœ‰äººçš„é‡‘ä¸»çˆ¸çˆ¸ã€‚";
            } else if (state.stats.san < 20 && state.stats.passion > 50) {
                title = "æ·±æ¸Šå‡è§†è€… (ç–¯ç‹—)";
                desc = "ä¸ºäº†ç»´æŠ¤CPï¼Œä½ æ’•éäº†å¯¹å®¶ã€æ‹†å®¶å’Œå®˜æ–¹ã€‚ä½ çš„IDè®©äººé—»é£ä¸§èƒ†ã€‚";
            } else if (state.stats.works > 10 && state.stats.myHeat < 50) {
                title = "ä¸ºçˆ±å‘ç”µçš„è‹¦è¡Œåƒ§";
                desc = "è™½ç„¶æ²¡äººçœ‹ï¼Œä½†ä½ çœŸçš„å¾ˆçˆ±ä»–ä»¬ã€‚è¿™å°±å¤Ÿäº†ã€‚";
            } else if (state.flags.toxic) {
                title = "æŒ‚äººåšä¸» / ç“œä¸»";
                desc = "æ¯”èµ·ç£•CPï¼Œä½ ä¼¼ä¹æ›´æ“…é•¿æ•´ç†åƒç“œæ–‡æ¡£ã€‚";
            }

            document.getElementById('final-title').innerText = title;
            document.getElementById('final-desc').innerText = desc;

            renderRadarChart();
        }

        function renderRadarChart() {
            // ç®€å•çš„SVGé›·è¾¾å›¾ç»˜åˆ¶
            const svg = document.getElementById('radar-svg');
            const center = 100;
            const radius = 80;
            const stats = [
                state.stats.love, // å¨åŠ›
                state.stats.myHeat, // çƒ­åº¦
                state.stats.tech, // æŠ€æœ¯
                state.stats.money, // è´¢åŠ›
                state.stats.san // Sanå€¼
            ];
            const maxVals = [100, 200, 100, 5000, 100];
            const labels = ["å¨åŠ›", "çƒ­åº¦", "æŠ€æœ¯", "è´¢åŠ›", "Sanå€¼"];
            
            // èƒŒæ™¯ç½‘æ ¼
            let bgHtml = `<circle cx="100" cy="100" r="80" fill="#374151" stroke="#4b5563" stroke-width="1"/>`;
            bgHtml += `<circle cx="100" cy="100" r="40" fill="none" stroke="#4b5563" stroke-width="1"/>`;
            
            // è®¡ç®—ç‚¹
            let points = [];
            let labelHtml = "";
            
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                // å½’ä¸€åŒ– 0-1
                let ratio = stats[i] / maxVals[i];
                if(ratio > 1) ratio = 1;
                if(ratio < 0.1) ratio = 0.1;
                
                const x = center + radius * ratio * Math.cos(angle);
                const y = center + radius * ratio * Math.sin(angle);
                points.push(`${x},${y}`);

                // æ ‡ç­¾åæ ‡
                const lx = center + (radius + 15) * Math.cos(angle);
                const ly = center + (radius + 15) * Math.sin(angle);
                labelHtml += `<text x="${lx}" y="${ly}" fill="#fbbf24" font-size="10" text-anchor="middle" alignment-baseline="middle">${labels[i]}</text>`;
            }

            const polyPoints = points.join(" ");
            const dataHtml = `<polygon points="${polyPoints}" fill="rgba(59, 130, 246, 0.6)" stroke="#3b82f6" stroke-width="2"/>`;
            
            svg.innerHTML = bgHtml + dataHtml + labelHtml;
        }

    </script>
</body>
</html>